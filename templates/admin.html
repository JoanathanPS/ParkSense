{% extends 'base.html' %}
{% from 'partials/summary_card.html' import render as summary_card %}

{% block title %}Admin Dashboard Â· ParkSense{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <div>
        <h1 class="h3 mb-1">Administration</h1>
        <p class="text-muted mb-0">Financial health, occupancy, and user engagement at a glance.</p>
    </div>
    <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Admin tools</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">{{ summary_card({'title': 'Total Revenue', 'value': '$' + '%.2f'|format(revenue.total_revenue), 'icon': 'bi-cash-stack'}) }}</div>
    <div class="col-md-4">{{ summary_card({'title': 'Active Reservations', 'value': active_reservations|length, 'icon': 'bi-calendar-event'}) }}</div>
    <div class="col-md-4">{{ summary_card({'title': 'Occupancy', 'value': summary.occupancy_rate|string + '%', 'icon': 'bi-speedometer'}) }}</div>
</div>

<div class="row g-4">
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 mb-0">Floor occupancy</h2>
                <p class="text-muted small mb-0">Utilization rate by floor level.</p>
            </div>
            <div class="card-body">
                {% if occupancy_by_floor %}
                <ul class="list-group list-group-flush">
                    {% for item in occupancy_by_floor %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-semibold">Floor {{ item.floor }}</span>
                            <span class="text-muted small d-block">{{ item.occupied }}/{{ item.total }} occupied</span>
                        </div>
                        <span class="badge bg-primary-subtle text-primary">{{ item.occupancy_rate }}%</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">No floor data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 mb-0">Zone occupancy</h2>
                <p class="text-muted small mb-0">Highlighting hotspots and availability trends.</p>
            </div>
            <div class="card-body">
                {% if occupancy_by_zone %}
                <ul class="list-group list-group-flush">
                    {% for item in occupancy_by_zone %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-semibold">{{ item.zone }}</span>
                            <span class="text-muted small d-block">{{ item.occupied }}/{{ item.total }} occupied</span>
                        </div>
                        <span class="badge bg-primary-subtle text-primary">{{ item.occupancy_rate }}%</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">No zone data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 mb-0">Active reservations</h2>
                <p class="text-muted small mb-0">Currently occupying slots across the facility.</p>
            </div>
            <div class="card-body">
                {% if active_reservations %}
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Reservation</th>
                                <th scope="col">User</th>
                                <th scope="col">Slot</th>
                                <th scope="col">Ends</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in active_reservations %}
                            <tr>
                                <td>#{{ reservation.reservation_id }}</td>
                                <td>{{ reservation.username }}</td>
                                <td>{{ reservation.slot_number }}</td>
                                <td>{{ reservation.end_time }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No active reservations right now.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 mb-0">Recent wallet activity</h2>
                <p class="text-muted small mb-0">Top-ups and wallet adjustments.</p>
            </div>
            <div class="card-body">
                {% if wallet_transactions %}
                <ul class="list-group list-group-flush">
                    {% for tx in wallet_transactions %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-semibold">{{ tx.username }}</span>
                            <span class="text-muted small d-block">{{ tx.transaction_type|replace('_', ' ')|title }}</span>
                        </div>
                        {% set badge_class = 'bg-success-subtle text-success border border-success-subtle' if tx.amount > 0 else 'bg-danger-subtle text-danger border border-danger-subtle' %}
                        <span class="badge {{ badge_class }}">{{ '$' + ('+' if tx.amount > 0 else '') + '%.2f'|format(tx.amount) }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">No wallet transactions yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
