{% extends "base.html" %}

{% block title %}Analytics - Smart Parking{% endblock %}

{% block content %}
<div class="analytics-page">
    <h2>Analytics & Predictions</h2>
    
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>Revenue Report</h3>
            <div id="revenue-data">
                <p class="revenue-total">Total Revenue: <span class="highlight">${{ "%.2f"|format(revenue.total_revenue) }}</span></p>
                
                {% if revenue.revenue_by_slot_type %}
                <h4>Revenue by Slot Type</h4>
                <ul class="revenue-list">
                    {% for item in revenue.revenue_by_slot_type %}
                    <li>{{ item[0] }}: <span class="highlight">${{ "%.2f"|format(item[1]) }}</span></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        
        <div class="analytics-card">
            <h3>Peak Demand Prediction</h3>
            <div id="prediction-data">
                {% if predictions.peak_hours %}
                <p>Peak Hours: <span class="highlight">{{ predictions.peak_hours|join(', ') }}</span></p>
                <p class="prediction-text">{{ predictions.recommendation }}</p>
                {% else %}
                <p>Collecting data for predictions...</p>
                {% endif %}
            </div>
        </div>
        
        <div class="analytics-card">
            <h3>Busiest Zones</h3>
            <div id="zones-data">
                {% if predictions.busiest_zones %}
                <ul class="zone-list">
                    {% for zone in predictions.busiest_zones %}
                    <li>
                        <strong>{{ zone[0] }}</strong>: 
                        {{ zone[1] }} reservations, 
                        <span class="highlight">${{ "%.2f"|format(zone[2]) }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No zone data available yet.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="analytics-card">
            <h3>Slot Type Preferences</h3>
            <div id="preferences-data">
                {% if predictions.slot_type_preferences %}
                <ul class="preference-list">
                    {% for pref in predictions.slot_type_preferences %}
                    <li>{{ pref[0] }}: <span class="highlight">{{ pref[1] }} reservations</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No preference data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateAnalytics() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            const revenueHTML = `
                <p class="revenue-total">Total Revenue: <span class="highlight">$${data.revenue.total_revenue.toFixed(2)}</span></p>
                ${data.revenue.revenue_by_slot_type.length > 0 ? `
                    <h4>Revenue by Slot Type</h4>
                    <ul class="revenue-list">
                        ${data.revenue.revenue_by_slot_type.map(item => 
                            `<li>${item[0]}: <span class="highlight">$${item[1].toFixed(2)}</span></li>`
                        ).join('')}
                    </ul>
                ` : ''}
            `;
            document.getElementById('revenue-data').innerHTML = revenueHTML;
            
            const predictionHTML = data.predictions.peak_hours.length > 0 ? `
                <p>Peak Hours: <span class="highlight">${data.predictions.peak_hours.join(', ')}</span></p>
                <p class="prediction-text">${data.predictions.recommendation}</p>
            ` : '<p>Collecting data for predictions...</p>';
            document.getElementById('prediction-data').innerHTML = predictionHTML;
            
            const zonesHTML = data.predictions.busiest_zones.length > 0 ? `
                <ul class="zone-list">
                    ${data.predictions.busiest_zones.map(zone => 
                        `<li><strong>${zone[0]}</strong>: ${zone[1]} reservations, <span class="highlight">$${zone[2].toFixed(2)}</span></li>`
                    ).join('')}
                </ul>
            ` : '<p>No zone data available yet.</p>';
            document.getElementById('zones-data').innerHTML = zonesHTML;
            
            const preferencesHTML = data.predictions.slot_type_preferences.length > 0 ? `
                <ul class="preference-list">
                    ${data.predictions.slot_type_preferences.map(pref => 
                        `<li>${pref[0]}: <span class="highlight">${pref[1]} reservations</span></li>`
                    ).join('')}
                </ul>
            ` : '<p>No preference data available yet.</p>';
            document.getElementById('preferences-data').innerHTML = preferencesHTML;
        })
        .catch(error => console.error('Error updating analytics:', error));
}

setInterval(updateAnalytics, 5000);
</script>
{% endblock %}
